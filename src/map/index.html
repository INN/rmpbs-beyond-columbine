<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
  <style>
      svg { width: 100%; height: 90%;}
  </style>
</head>

<body>
  <div id="map" style="height:500px;"></div>
  <div id="filter" style="float:left; width:40%;"></div>
  <div id="table" style="float:right; width:40%;">
    <table class="objecttable">
     <thead>
      <tr><th>date</th><th>city</th><th>state</th><th>killed</th></tr>
     </thead>
     <tbody></tbody>
    </table>
  </div>

  <script>

    var url = "http://enjalot.github.io/wwsd/data/world/world-110m.geojson";
    var data_url = "data.csv";

    var svg = d3.select("#map").append("svg");
    var projection = d3.geoAlbersUsa().scale(848).translate([480, 180]);
    var path = d3.geoPath().projection(projection);

    var table = d3.select("#table tbody");
    
    Promise.all([d3.json(url), d3.csv(data_url)]).then(function(data) {
      var world = data[0];
      var places = data[1];
      places = places.map(function(d) {
        return {
          lat: d.lat,
          long: d.long,
          date: d.date,
          city: d.city,
          state: d.state,
          killed: d.killed,
        }
      });

      var states = d3.nest()
      .key(function(d) { return d.state; })
      .rollup(function(v) { return {
        count: v.length
      }; })
      .entries(places);

      states.sort(function(a, b) {
          var x = a.key; var y = b.key;
          return ((x < y) ? -1 : ((x > y) ? 1 : 0));
      });

      var filterData = function() {
          var selectedState = d3.select(this).property('value');
          d3.selectAll("table tbody tr").style("display", "none");
          d3.selectAll("tr." + selectedState).style("display", "table-row");
      };

      var dropdown = d3.select("#filter")
          .insert("select")
          .on("change", filterData);

      dropdown.selectAll("option")
                    .data(states)
                  .enter().append("option")
                    .attr("value", function (d) { return d.key; })
                    .text(function (d) {
                        return d.key;
                    });



      placesfortable = places.map(function(d) {
        return {
          date: d.date,
          city: d.city,
          state: d.state,
          killed: d.killed,
        }
      });
      
      svg.append("path")
      	.attr("d", path(world))
      	.attr("fill", "lightgray")
      	.attr("stroke", "white");
      
      svg.selectAll("circle")
      	.data(places)
      .enter()
      	.append("circle")
      	.attr("r", function(d) {
        	return 10;
      	})
      	.attr("cx", function(d) {
        	return 0;
      	})
      	.attr("cy", function(d) {
        	return 0;
      	})
        .attr("transform", function(d) {
          return "translate(" + projection([+d.long, +d.lat]) + ")";
        })
      	.attr("fill", "black")
      	.attr("opacity", 0.3);

      var tr = table
       .selectAll("tr")
       .data(placesfortable)
       .enter().append("tr")
       .attr("class",function(d) { return d.state; });

      var td = tr.selectAll("td")
       .data(function(d, i) { return Object.values(d); })
       .enter().append("td")
         .text(function(d) { return d; });
    });
    
    
  </script>  
</body>